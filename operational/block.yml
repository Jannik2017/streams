- name: Get current IP addresses on current interfaces
  vyos.vyos.vyos_command:
    commands:
      - show configuration commands | match "interfaces {{ iface.interface_type }} {{ iface.interface }}.*address"
  register: iface_config

- name: Extract current IP addresses for all interfaces
  set_fact:
    current_iface_ips: "{{ iface_config.stdout_lines | regex_findall(' address \\S([\\d.]+/\\d+)') }}"

- name: Find surplus IPv4 addresses on iface.interface
  set_fact:
    surplus_iface_ips: "{{ current_iface_ips | difference(iface.ipv4_address) }}"

- name: Delete surplus IPs from interface loopback
  vyos.vyos.vyos_config:
    lines:
      - delete interface {{ iface.interface_type }} {{ iface.interface }} address '{{ current_surplus_ip }}'
    match: 'none'
  loop: "{{ surplus_iface_ips }}"
  loop_control:
    loop_var: 'current_surplus_ip'

- name: Set interface IP address(es) from inventory
  vyos.vyos.vyos_l3_interfaces:
    config:
      - name: "{{ item.0.interface }}"
        ipv4:
          - address: "{{ item.1 }}"
  loop: "{{ hostvars[inventory_hostname]['interfaces'] | subelements('ipv4_address') }}"
  loop_control:
    loop_var: 'item'

