{# vrf #}
{% if vrfs is defined %}
  {% for vrf in vrfs %}
    vrf name {{ vrf.vrf }} table '{{ vrf.table }}'
  {% endfor %}
{% endif %}

{# services #}
{% if services is defined %}
  {# ssh #}
  {% if ssh is defined %}
    service ssh port '{{ ssh.port }}'
    service ssh vrf '{{ ssh.vrf }}'
  {% endif %}
{% endif %}

{# interfaces #}
{% for item in interfaces %}
    {#{% if item.interface != "eth0" %}
        delete interfaces {{ item.interface_type }} {{ item.interface }}
    {% endif %}#}
    {% if item.interface_type == "bridge" %}
        {% for m in item.members %}
            interfaces {{ item.interface_type }} {{ item.interface }} member interface {{ m }}
        {% endfor %}
    {% endif %}
    {% if item.interface_type == "wireguard" %}
        interfaces wireguard wg0 private-key '{{ item.private_key }}'
        interfaces wireguard wg0 port '{{ item.port }}'
        {% for p in item.peers %}
            interfaces wireguard wg0 description '{{ p.peer }}'
            interfaces wireguard wg0 peer {{ p.peer }} address '{{ p.address }}'
            interfaces wireguard wg0 peer {{ p.peer }} allowed-ips '{{ p.allowed_ips }}'
            interfaces wireguard wg0 peer {{ p.peer }} port '{{ p.port }}'
            interfaces wireguard wg0 peer {{ p.peer }} public-key '{{ p.public_key }}'
        {% endfor %}
    {% endif %}
    {% if item.mtu is defined %}
        interfaces {{ item.interface_type }} {{ item.interface }} mtu '{{ item.mtu }}'
        interfaces {{ item.interface_type }} {{ item.interface }} ip adjust-mss '{{ item.mtu - 40 }}'
        interfaces {{ item.interface_type }} {{ item.interface }} ipv6 adjust-mss '{{ item.mtu - 60 }}'
    {% endif %}
    {% if item.vrf is defined %}
        interfaces {{ item.interface_type }} {{ item.interface }} vrf '{{ item.vrf }}'
    {% endif %}
    interfaces {{ item.interface_type }} {{ item.interface }} address '{{ item.ipv4_address }}'
{% endfor %}

{# policy #}
{% if policy is defined %}
    {% for p in policy %}
        {# route-map #}
        {% if p.route_maps is defined %}
            {% for rm in p.route_maps %}
                policy route-map {{ rm.route_map }} description {{ rm.description }}
                {% for r in rm.rules %}
                    policy route-map {{ rm.route_map }} rule {{ r.rule }} action {{ r.action }}
                    {% if r.match is defined %}
                        policy route-map {{ rm.route_map }} rule {{ r.rule }} match {{ r.match }}
                    {% endif %}
                    {% if r.is defined %}
                        policy route-map {{ rm.route_map }} rule {{ r.rule }} {{ r.}}
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% endif %}
    {% endfor %}
{% endif %}

{# bgp #}
{% if bgp is defined %}
    {# parameters #}
    protocols bgp parameters router-id '{{ bgp.router_id }}'
    protocols bgp system-as '{{ bgp.as }}'
    {# 'global' afis #}
    {% if bgp.afis is defined %}
        {% for af in bgp.afis %}
            {% if af.aggregates is defined %}
                {% for aggregate in af.aggregates %}
                    protocols bgp address-family {{ af.afi }} aggregate-address {{ aggregate }}
                {% endfor %}
            {% endif %}
            {% if af.networks is defined %}
                {% for network in af.networks %}
                    protocols bgp address-family {{ af.afi }} network {{ network }}
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endif %}
    {# neighbors #}
    {% for n in bgp.neighbors %}
        protocols bgp neighbor {{ n.ipv4_address }} description '{{ n.description }}'
        protocols bgp neighbor {{ n.ipv4_address }} remote-as '{{ n.remote_as }}'
        protocols bgp neighbor {{ n.ipv4_address }} update-source '{{ n.update_source }}'
        {% if n.afis is defined %}
            {% for af in n.afis %}
                protocols bgp neighbor {{ n.ipv4_address }} address-family {{ af.afi }}
                {% if af.next_hop is defined %}
                    protocols bgp neighbor {{ n.ipv4_address }} address-family {{ af.afi }} {{ af.next_hop }}
                {% endif %}
                {% if af.route_maps.route_map_export is defined %}
                    protocols bgp neighbor {{ n.ipv4_address }} address-family {{ af.afi }} route-map export '{{ af.route_maps.route_map_export }}'
                {% endif %}
                {% if af.route_maps.route_map_import is defined %}
                    protocols bgp neighbor {{ n.ipv4_address }} address-family {{ af.afi }} route-map import '{{ af.route_maps.route_map_import }}'
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}
{% endif %}

{# mpls #}
{% if mpls is defined %}
    {% for i in mpls.interfaces %}
        protocols mpls interface '{{ i.interface }}'
    {% endfor %}
    {% if mpls.ldp is defined %}
        protocols mpls ldp router-id '{{ mpls.ldp.router_id }}'
        protocols mpls ldp discovery transport-ipv4-address '{{ mpls.ldp.router_id }}'
        {% if mpls.ldp.interfaces is defined %}
            {% for i in mpls.ldp.interfaces %}
                protocols mpls ldp interface '{{ i.interface }}'
            {% endfor %}
        {% endif %}
    {% endif %}
{% endif %}

{# ospf #}
{% if ospf is defined %}
    protocols ospf parameters router-id '{{ ospf.router_id }}'
    {% for a in ospf.areas %}
        {% for n in a.networks %}
            protocols ospf area {{ a.area }} network '{{ n }}'
        {% endfor %}
    {% endfor %}
    {% for i in ospf.interfaces %}
        {% if i.passive is defined and i.passive == true %}
            protocols ospf interface {{ i.interface }} passive
        {% else %}
            protocols ospf interface {{ i.interface }}
        {% endif %}
    {% endfor %}
{% endif %}

{# static #}
{% if static is defined %}
    {% for route in static.routes %}
        protocols static route {{ route.route }} next-hop {{ route.next_hop }}
    {% endfor %}
{% endif %}

{# common stuff #}
service ntp server 1.pool.ntp.org
service ntp server 2.pool.ntp.org
service ssh client-keepalive-interval '180'
service ssh port '22'
system config-management commit-revisions '100'
system conntrack modules ftp
system conntrack modules h323
system conntrack modules nfs
system conntrack modules pptp
system conntrack modules sip
system conntrack modules sqlnet
system conntrack modules tftp
system host-name '{{ ansible_hostname }}'
system login user vyos authentication encrypted-password '$6$rounds=656000$5/Y/ohzSSjTR9jNp$n7lIywCqAQgwRLULDtdIGBAG9V7mRbTV5ECWX1VbplUn1AJVOskc5cEZZk4YquB.9HBB25aYh6pstcjsYCHQD0'
system login user vyos authentication public-keys aibix@admin2 key 'AAAAC3NzaC1lZDI1NTE5AAAAIE5m1XvL7TLfEQyZs6IaySJxAoIS22V2TenKvqboXZqN'
system login user vyos authentication public-keys aibix@admin2 type 'ssh-ed25519'
system login user vyos authentication public-keys aibix@doodlemox key 'AAAAC3NzaC1lZDI1NTE5AAAAIJhIGgYUf/Sl4xr4uv+nrMbpDhulZWQxynX5OBTvalsz'
system login user vyos authentication public-keys aibix@doodlemox type 'ssh-ed25519'
system login user vyos authentication public-keys aibix@minismox key 'AAAAC3NzaC1lZDI1NTE5AAAAIJPRSV+ocoYTP26UwMYUXsd0gVKSmrFC3WaOVJwEY0L1'
system login user vyos authentication public-keys aibix@minismox type 'ssh-ed25519'
